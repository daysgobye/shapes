{"ast":null,"code":"\"use strict\";\n\nvar __extends = this && this.__extends || function () {\n  var _extendStatics = function extendStatics(d, b) {\n    _extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) {\n        if (b.hasOwnProperty(p)) d[p] = b[p];\n      }\n    };\n\n    return _extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    _extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar Util_1 = require(\"../Util\");\n\nvar Factory_1 = require(\"../Factory\");\n\nvar Node_1 = require(\"../Node\");\n\nvar Shape_1 = require(\"../Shape\");\n\nvar Rect_1 = require(\"./Rect\");\n\nvar Group_1 = require(\"../Group\");\n\nvar Global_1 = require(\"../Global\");\n\nvar Validators_1 = require(\"../Validators\");\n\nvar Global_2 = require(\"../Global\");\n\nvar EVENTS_NAME = 'tr-konva';\nvar ATTR_CHANGE_LIST = ['resizeEnabledChange', 'rotateAnchorOffsetChange', 'rotateEnabledChange', 'enabledAnchorsChange', 'anchorSizeChange', 'borderEnabledChange', 'borderStrokeChange', 'borderStrokeWidthChange', 'borderDashChange', 'anchorStrokeChange', 'anchorStrokeWidthChange', 'anchorFillChange', 'anchorCornerRadiusChange', 'ignoreStrokeChange'].map(function (e) {\n  return e + (\".\" + EVENTS_NAME);\n}).join(' ');\nvar NODE_RECT = 'nodeRect';\nvar TRANSFORM_CHANGE_STR = ['widthChange', 'heightChange', 'scaleXChange', 'scaleYChange', 'skewXChange', 'skewYChange', 'rotationChange', 'offsetXChange', 'offsetYChange', 'transformsEnabledChange', 'strokeWidthChange'].map(function (e) {\n  return e + (\".\" + EVENTS_NAME);\n}).join(' ');\nvar ANGLES = {\n  'top-left': -45,\n  'top-center': 0,\n  'top-right': 45,\n  'middle-right': -90,\n  'middle-left': 90,\n  'bottom-left': -135,\n  'bottom-center': 180,\n  'bottom-right': 135\n};\n\nfunction getCursor(anchorName, rad, isMirrored) {\n  if (anchorName === 'rotater') {\n    return 'crosshair';\n  }\n\n  rad += Util_1.Util._degToRad(ANGLES[anchorName] || 0);\n\n  if (isMirrored) {\n    rad *= -1;\n  }\n\n  var angle = (Util_1.Util._radToDeg(rad) % 360 + 360) % 360;\n\n  if (Util_1.Util._inRange(angle, 315 + 22.5, 360) || Util_1.Util._inRange(angle, 0, 22.5)) {\n    return 'ns-resize';\n  } else if (Util_1.Util._inRange(angle, 45 - 22.5, 45 + 22.5)) {\n    return 'nesw-resize';\n  } else if (Util_1.Util._inRange(angle, 90 - 22.5, 90 + 22.5)) {\n    return 'ew-resize';\n  } else if (Util_1.Util._inRange(angle, 135 - 22.5, 135 + 22.5)) {\n    return 'nwse-resize';\n  } else if (Util_1.Util._inRange(angle, 180 - 22.5, 180 + 22.5)) {\n    return 'ns-resize';\n  } else if (Util_1.Util._inRange(angle, 225 - 22.5, 225 + 22.5)) {\n    return 'nesw-resize';\n  } else if (Util_1.Util._inRange(angle, 270 - 22.5, 270 + 22.5)) {\n    return 'ew-resize';\n  } else if (Util_1.Util._inRange(angle, 315 - 22.5, 315 + 22.5)) {\n    return 'nwse-resize';\n  } else {\n    Util_1.Util.error('Transformer has unknown angle for cursor detection: ' + angle);\n    return 'pointer';\n  }\n}\n\nvar ANCHORS_NAMES = ['top-left', 'top-center', 'top-right', 'middle-right', 'middle-left', 'bottom-left', 'bottom-center', 'bottom-right'];\nvar MAX_SAFE_INTEGER = 100000000;\n\nvar Transformer = function (_super) {\n  __extends(Transformer, _super);\n\n  function Transformer(config) {\n    var _this = _super.call(this, config) || this;\n\n    _this._transforming = false;\n\n    _this._createElements();\n\n    _this._handleMouseMove = _this._handleMouseMove.bind(_this);\n    _this._handleMouseUp = _this._handleMouseUp.bind(_this);\n    _this.update = _this.update.bind(_this);\n\n    _this.on(ATTR_CHANGE_LIST, _this.update);\n\n    if (_this.getNode()) {\n      _this.update();\n    }\n\n    return _this;\n  }\n\n  Transformer.prototype.attachTo = function (node) {\n    this.setNode(node);\n    return this;\n  };\n\n  Transformer.prototype.setNode = function (node) {\n    var _this = this;\n\n    if (this._node) {\n      this.detach();\n    }\n\n    this._node = node;\n\n    this._resetTransformCache();\n\n    var additionalEvents = node._attrsAffectingSize.map(function (prop) {\n      return prop + 'Change.' + EVENTS_NAME;\n    }).join(' ');\n\n    var onChange = function onChange() {\n      _this._resetTransformCache();\n\n      if (!_this._transforming) {\n        _this.update();\n      }\n    };\n\n    node.on(additionalEvents, onChange);\n    node.on(TRANSFORM_CHANGE_STR, onChange);\n    node.on(\"xChange.\" + EVENTS_NAME + \" yChange.\" + EVENTS_NAME, function () {\n      return _this._resetTransformCache();\n    });\n    var elementsCreated = !!this.findOne('.top-left');\n\n    if (elementsCreated) {\n      this.update();\n    }\n\n    return this;\n  };\n\n  Transformer.prototype.getNode = function () {\n    return this._node;\n  };\n\n  Transformer.prototype.detach = function () {\n    if (this.getNode()) {\n      this.getNode().off('.' + EVENTS_NAME);\n      this._node = undefined;\n    }\n\n    this._resetTransformCache();\n  };\n\n  Transformer.prototype._resetTransformCache = function () {\n    this._clearCache(NODE_RECT);\n\n    this._clearCache('transform');\n\n    this._clearSelfAndDescendantCache('absoluteTransform');\n  };\n\n  Transformer.prototype._getNodeRect = function () {\n    return this._getCache(NODE_RECT, this.__getNodeRect);\n  };\n\n  Transformer.prototype.__getNodeRect = function () {\n    var node = this.getNode();\n\n    if (!node) {\n      return {\n        x: -MAX_SAFE_INTEGER,\n        y: -MAX_SAFE_INTEGER,\n        width: 0,\n        height: 0,\n        rotation: 0\n      };\n    }\n\n    if (node.parent && this.parent && node.parent !== this.parent) {\n      Util_1.Util.warn('Transformer and attached node have different parents. Konva does not support such case right now. Please move Transformer to the parent of attaching node.');\n    }\n\n    var rect = node.getClientRect({\n      skipTransform: true,\n      skipShadow: true,\n      skipStroke: this.ignoreStroke()\n    });\n    var rotation = Global_1.Konva.getAngle(node.rotation());\n    var dx = rect.x * node.scaleX() - node.offsetX() * node.scaleX();\n    var dy = rect.y * node.scaleY() - node.offsetY() * node.scaleY();\n    return {\n      x: node.x() + dx * Math.cos(rotation) + dy * Math.sin(-rotation),\n      y: node.y() + dy * Math.cos(rotation) + dx * Math.sin(rotation),\n      width: rect.width * node.scaleX(),\n      height: rect.height * node.scaleY(),\n      rotation: node.rotation()\n    };\n  };\n\n  Transformer.prototype.getX = function () {\n    return this._getNodeRect().x;\n  };\n\n  Transformer.prototype.getY = function () {\n    return this._getNodeRect().y;\n  };\n\n  Transformer.prototype.getRotation = function () {\n    return this._getNodeRect().rotation;\n  };\n\n  Transformer.prototype.getWidth = function () {\n    return this._getNodeRect().width;\n  };\n\n  Transformer.prototype.getHeight = function () {\n    return this._getNodeRect().height;\n  };\n\n  Transformer.prototype._createElements = function () {\n    this._createBack();\n\n    ANCHORS_NAMES.forEach(function (name) {\n      this._createAnchor(name);\n    }.bind(this));\n\n    this._createAnchor('rotater');\n  };\n\n  Transformer.prototype._createAnchor = function (name) {\n    var _this = this;\n\n    var anchor = new Rect_1.Rect({\n      stroke: 'rgb(0, 161, 255)',\n      fill: 'white',\n      strokeWidth: 1,\n      name: name + ' _anchor',\n      dragDistance: 0,\n      draggable: true\n    });\n    var self = this;\n    anchor.on('mousedown touchstart', function (e) {\n      self._handleMouseDown(e);\n    });\n    anchor.on('dragstart', function (e) {\n      e.cancelBubble = true;\n    });\n    anchor.on('dragmove', function (e) {\n      e.cancelBubble = true;\n    });\n    anchor.on('dragend', function (e) {\n      e.cancelBubble = true;\n    });\n    anchor.on('mouseenter', function () {\n      var rad = Global_1.Konva.getAngle(_this.rotation());\n\n      var scale = _this.getNode().getAbsoluteScale();\n\n      var isMirrored = scale.y * scale.x < 0;\n      var cursor = getCursor(name, rad, isMirrored);\n      anchor.getStage().content.style.cursor = cursor;\n      _this._cursorChange = true;\n    });\n    anchor.on('mouseout', function () {\n      if (!anchor.getStage() || !anchor.getParent()) {\n        return;\n      }\n\n      anchor.getStage().content.style.cursor = '';\n      _this._cursorChange = false;\n    });\n    this.add(anchor);\n  };\n\n  Transformer.prototype._createBack = function () {\n    var back = new Shape_1.Shape({\n      name: 'back',\n      width: 0,\n      height: 0,\n      listening: false,\n      sceneFunc: function sceneFunc(ctx) {\n        var tr = this.getParent();\n        var padding = tr.padding();\n        ctx.beginPath();\n        ctx.rect(-padding, -padding, this.width() + padding * 2, this.height() + padding * 2);\n        ctx.moveTo(this.width() / 2, -padding);\n\n        if (tr.rotateEnabled()) {\n          ctx.lineTo(this.width() / 2, -tr.rotateAnchorOffset() * Util_1.Util._sign(this.height()) - padding);\n        }\n\n        ctx.fillStrokeShape(this);\n      }\n    });\n    this.add(back);\n  };\n\n  Transformer.prototype._handleMouseDown = function (e) {\n    this._movingAnchorName = e.target.name().split(' ')[0];\n\n    var attrs = this._getNodeRect();\n\n    var width = attrs.width;\n    var height = attrs.height;\n    var hypotenuse = Math.sqrt(Math.pow(width, 2) + Math.pow(height, 2));\n    this.sin = Math.abs(height / hypotenuse);\n    this.cos = Math.abs(width / hypotenuse);\n    window.addEventListener('mousemove', this._handleMouseMove);\n    window.addEventListener('touchmove', this._handleMouseMove);\n    window.addEventListener('mouseup', this._handleMouseUp, true);\n    window.addEventListener('touchend', this._handleMouseUp, true);\n    this._transforming = true;\n\n    this._fire('transformstart', {\n      evt: e\n    });\n\n    this.getNode()._fire('transformstart', {\n      evt: e\n    });\n  };\n\n  Transformer.prototype._handleMouseMove = function (e) {\n    var x, y, newHypotenuse;\n    var anchorNode = this.findOne('.' + this._movingAnchorName);\n    var stage = anchorNode.getStage();\n    var box = stage.getContent().getBoundingClientRect();\n    var zeroPoint = {\n      x: box.left,\n      y: box.top\n    };\n    var pointerPos = {\n      left: e.clientX !== undefined ? e.clientX : e.touches[0].clientX,\n      top: e.clientX !== undefined ? e.clientY : e.touches[0].clientY\n    };\n    var newAbsPos = {\n      x: pointerPos.left - zeroPoint.x,\n      y: pointerPos.top - zeroPoint.y\n    };\n    anchorNode.setAbsolutePosition(newAbsPos);\n    var keepProportion = this.keepRatio() || e.shiftKey;\n    var padding = this.padding();\n\n    if (this._movingAnchorName === 'top-left') {\n      if (keepProportion) {\n        newHypotenuse = Math.sqrt(Math.pow(this.findOne('.bottom-right').x() - anchorNode.x() - padding * 2, 2) + Math.pow(this.findOne('.bottom-right').y() - anchorNode.y() - padding * 2, 2));\n        var reverseX = this.findOne('.top-left').x() > this.findOne('.bottom-right').x() ? -1 : 1;\n        var reverseY = this.findOne('.top-left').y() > this.findOne('.bottom-right').y() ? -1 : 1;\n        x = newHypotenuse * this.cos * reverseX;\n        y = newHypotenuse * this.sin * reverseY;\n        this.findOne('.top-left').x(this.findOne('.bottom-right').x() - x - padding * 2);\n        this.findOne('.top-left').y(this.findOne('.bottom-right').y() - y - padding * 2);\n      }\n    } else if (this._movingAnchorName === 'top-center') {\n      this.findOne('.top-left').y(anchorNode.y());\n    } else if (this._movingAnchorName === 'top-right') {\n      if (keepProportion) {\n        newHypotenuse = Math.sqrt(Math.pow(anchorNode.x() - this.findOne('.bottom-left').x() - padding * 2, 2) + Math.pow(this.findOne('.bottom-left').y() - anchorNode.y() - padding * 2, 2));\n        var reverseX = this.findOne('.top-right').x() < this.findOne('.top-left').x() ? -1 : 1;\n        var reverseY = this.findOne('.top-right').y() > this.findOne('.bottom-left').y() ? -1 : 1;\n        x = newHypotenuse * this.cos * reverseX;\n        y = newHypotenuse * this.sin * reverseY;\n        this.findOne('.top-right').x(x + padding);\n        this.findOne('.top-right').y(this.findOne('.bottom-left').y() - y - padding * 2);\n      }\n\n      var pos = anchorNode.position();\n      this.findOne('.top-left').y(pos.y);\n      this.findOne('.bottom-right').x(pos.x);\n    } else if (this._movingAnchorName === 'middle-left') {\n      this.findOne('.top-left').x(anchorNode.x());\n    } else if (this._movingAnchorName === 'middle-right') {\n      this.findOne('.bottom-right').x(anchorNode.x());\n    } else if (this._movingAnchorName === 'bottom-left') {\n      if (keepProportion) {\n        newHypotenuse = Math.sqrt(Math.pow(this.findOne('.top-right').x() - anchorNode.x() - padding * 2, 2) + Math.pow(anchorNode.y() - this.findOne('.top-right').y() - padding * 2, 2));\n        var reverseX = this.findOne('.top-right').x() < this.findOne('.bottom-left').x() ? -1 : 1;\n        var reverseY = this.findOne('.bottom-right').y() < this.findOne('.top-left').y() ? -1 : 1;\n        x = newHypotenuse * this.cos * reverseX;\n        y = newHypotenuse * this.sin * reverseY;\n        this.findOne('.bottom-left').x(this.findOne('.top-right').x() - x - padding * 2);\n        this.findOne('.bottom-left').y(y + padding);\n      }\n\n      pos = anchorNode.position();\n      this.findOne('.top-left').x(pos.x);\n      this.findOne('.bottom-right').y(pos.y);\n    } else if (this._movingAnchorName === 'bottom-center') {\n      this.findOne('.bottom-right').y(anchorNode.y());\n    } else if (this._movingAnchorName === 'bottom-right') {\n      if (keepProportion) {\n        newHypotenuse = Math.sqrt(Math.pow(this.findOne('.bottom-right').x() - padding, 2) + Math.pow(this.findOne('.bottom-right').y() - padding, 2));\n        var reverseX = this.findOne('.top-left').x() > this.findOne('.bottom-right').x() ? -1 : 1;\n        var reverseY = this.findOne('.top-left').y() > this.findOne('.bottom-right').y() ? -1 : 1;\n        x = newHypotenuse * this.cos * reverseX;\n        y = newHypotenuse * this.sin * reverseY;\n        this.findOne('.bottom-right').x(x + padding);\n        this.findOne('.bottom-right').y(y + padding);\n      }\n    } else if (this._movingAnchorName === 'rotater') {\n      var attrs = this._getNodeRect();\n\n      x = anchorNode.x() - attrs.width / 2;\n      y = -anchorNode.y() + attrs.height / 2;\n      var dAlpha = Math.atan2(-y, x) + Math.PI / 2;\n\n      if (attrs.height < 0) {\n        dAlpha -= Math.PI;\n      }\n\n      var rot = Global_1.Konva.getAngle(this.rotation());\n\n      var newRotation = Util_1.Util._radToDeg(rot) + Util_1.Util._radToDeg(dAlpha);\n\n      var alpha = Global_1.Konva.getAngle(this.getNode().rotation());\n\n      var newAlpha = Util_1.Util._degToRad(newRotation);\n\n      var snaps = this.rotationSnaps();\n      var offset = 0.1;\n\n      for (var i = 0; i < snaps.length; i++) {\n        var angle = Global_1.Konva.getAngle(snaps[i]);\n        var dif = Math.abs(angle - Util_1.Util._degToRad(newRotation)) % (Math.PI * 2);\n\n        if (dif < offset) {\n          newRotation = Util_1.Util._radToDeg(angle);\n          newAlpha = Util_1.Util._degToRad(newRotation);\n        }\n      }\n\n      var dx = padding;\n      var dy = padding;\n\n      this._fitNodeInto({\n        rotation: Global_1.Konva.angleDeg ? newRotation : Util_1.Util._degToRad(newRotation),\n        x: attrs.x + (attrs.width / 2 + padding) * (Math.cos(alpha) - Math.cos(newAlpha)) + (attrs.height / 2 + padding) * (Math.sin(-alpha) - Math.sin(-newAlpha)) - (dx * Math.cos(rot) + dy * Math.sin(-rot)),\n        y: attrs.y + (attrs.height / 2 + padding) * (Math.cos(alpha) - Math.cos(newAlpha)) + (attrs.width / 2 + padding) * (Math.sin(alpha) - Math.sin(newAlpha)) - (dy * Math.cos(rot) + dx * Math.sin(rot)),\n        width: attrs.width + padding * 2,\n        height: attrs.height + padding * 2\n      }, e);\n    } else {\n      console.error(new Error('Wrong position argument of selection resizer: ' + this._movingAnchorName));\n    }\n\n    if (this._movingAnchorName === 'rotater') {\n      return;\n    }\n\n    var centeredScaling = this.centeredScaling() || e.altKey;\n\n    if (centeredScaling) {\n      var topLeft = this.findOne('.top-left');\n      var bottomRight = this.findOne('.bottom-right');\n      var topOffsetX = topLeft.x() + padding;\n      var topOffsetY = topLeft.y() + padding;\n      var bottomOffsetX = this.getWidth() - bottomRight.x() + padding;\n      var bottomOffsetY = this.getHeight() - bottomRight.y() + padding;\n      bottomRight.move({\n        x: -topOffsetX,\n        y: -topOffsetY\n      });\n      topLeft.move({\n        x: bottomOffsetX,\n        y: bottomOffsetY\n      });\n    }\n\n    var absPos = this.findOne('.top-left').getAbsolutePosition(this.getParent());\n    x = absPos.x;\n    y = absPos.y;\n    var width = this.findOne('.bottom-right').x() - this.findOne('.top-left').x();\n    var height = this.findOne('.bottom-right').y() - this.findOne('.top-left').y();\n\n    this._fitNodeInto({\n      x: x + this.offsetX(),\n      y: y + this.offsetY(),\n      width: width,\n      height: height\n    }, e);\n  };\n\n  Transformer.prototype._handleMouseUp = function (e) {\n    this._removeEvents(e);\n  };\n\n  Transformer.prototype._removeEvents = function (e) {\n    if (this._transforming) {\n      this._transforming = false;\n      window.removeEventListener('mousemove', this._handleMouseMove);\n      window.removeEventListener('touchmove', this._handleMouseMove);\n      window.removeEventListener('mouseup', this._handleMouseUp, true);\n      window.removeEventListener('touchend', this._handleMouseUp, true);\n\n      this._fire('transformend', {\n        evt: e\n      });\n\n      var node = this.getNode();\n\n      if (node) {\n        node.fire('transformend', {\n          evt: e\n        });\n      }\n    }\n  };\n\n  Transformer.prototype._fitNodeInto = function (newAttrs, evt) {\n    var boundBoxFunc = this.boundBoxFunc();\n\n    if (boundBoxFunc) {\n      var oldAttrs = this._getNodeRect();\n\n      newAttrs = boundBoxFunc.call(this, oldAttrs, newAttrs);\n    }\n\n    var node = this.getNode();\n\n    if (newAttrs.rotation !== undefined) {\n      this.getNode().rotation(newAttrs.rotation);\n    }\n\n    var pure = node.getClientRect({\n      skipTransform: true,\n      skipShadow: true,\n      skipStroke: this.ignoreStroke()\n    });\n    var padding = this.padding();\n    var scaleX = pure.width ? (newAttrs.width - padding * 2) / pure.width : 1;\n    var scaleY = pure.height ? (newAttrs.height - padding * 2) / pure.height : 1;\n    var rotation = Global_1.Konva.getAngle(node.rotation());\n    var dx = pure.x * scaleX - padding - node.offsetX() * scaleX;\n    var dy = pure.y * scaleY - padding - node.offsetY() * scaleY;\n    this.getNode().setAttrs({\n      scaleX: scaleX,\n      scaleY: scaleY,\n      x: newAttrs.x - (dx * Math.cos(rotation) + dy * Math.sin(-rotation)),\n      y: newAttrs.y - (dy * Math.cos(rotation) + dx * Math.sin(rotation))\n    });\n\n    this._fire('transform', {\n      evt: evt\n    });\n\n    this.getNode()._fire('transform', {\n      evt: evt\n    });\n\n    this.update();\n    this.getLayer().batchDraw();\n  };\n\n  Transformer.prototype.forceUpdate = function () {\n    this._resetTransformCache();\n\n    this.update();\n  };\n\n  Transformer.prototype.update = function () {\n    var _this = this;\n\n    var attrs = this._getNodeRect();\n\n    var node = this.getNode();\n    var scale = {\n      x: 1,\n      y: 1\n    };\n\n    if (node && node.getParent()) {\n      scale = node.getParent().getAbsoluteScale();\n    }\n\n    var invertedScale = {\n      x: 1 / scale.x,\n      y: 1 / scale.y\n    };\n    var width = attrs.width;\n    var height = attrs.height;\n    var enabledAnchors = this.enabledAnchors();\n    var resizeEnabled = this.resizeEnabled();\n    var padding = this.padding();\n    var anchorSize = this.anchorSize();\n    this.find('._anchor').each(function (node) {\n      return node.setAttrs({\n        width: anchorSize,\n        height: anchorSize,\n        offsetX: anchorSize / 2,\n        offsetY: anchorSize / 2,\n        stroke: _this.anchorStroke(),\n        strokeWidth: _this.anchorStrokeWidth(),\n        fill: _this.anchorFill(),\n        cornerRadius: _this.anchorCornerRadius()\n      });\n    });\n    this.findOne('.top-left').setAttrs({\n      x: -padding,\n      y: -padding,\n      scale: invertedScale,\n      visible: resizeEnabled && enabledAnchors.indexOf('top-left') >= 0\n    });\n    this.findOne('.top-center').setAttrs({\n      x: width / 2,\n      y: -padding,\n      scale: invertedScale,\n      visible: resizeEnabled && enabledAnchors.indexOf('top-center') >= 0\n    });\n    this.findOne('.top-right').setAttrs({\n      x: width + padding,\n      y: -padding,\n      scale: invertedScale,\n      visible: resizeEnabled && enabledAnchors.indexOf('top-right') >= 0\n    });\n    this.findOne('.middle-left').setAttrs({\n      x: -padding,\n      y: height / 2,\n      scale: invertedScale,\n      visible: resizeEnabled && enabledAnchors.indexOf('middle-left') >= 0\n    });\n    this.findOne('.middle-right').setAttrs({\n      x: width + padding,\n      y: height / 2,\n      scale: invertedScale,\n      visible: resizeEnabled && enabledAnchors.indexOf('middle-right') >= 0\n    });\n    this.findOne('.bottom-left').setAttrs({\n      x: -padding,\n      y: height + padding,\n      scale: invertedScale,\n      visible: resizeEnabled && enabledAnchors.indexOf('bottom-left') >= 0\n    });\n    this.findOne('.bottom-center').setAttrs({\n      x: width / 2,\n      y: height + padding,\n      scale: invertedScale,\n      visible: resizeEnabled && enabledAnchors.indexOf('bottom-center') >= 0\n    });\n    this.findOne('.bottom-right').setAttrs({\n      x: width + padding,\n      y: height + padding,\n      scale: invertedScale,\n      visible: resizeEnabled && enabledAnchors.indexOf('bottom-right') >= 0\n    });\n    var scaledRotateAnchorOffset = -this.rotateAnchorOffset() * Math.abs(invertedScale.y);\n    this.findOne('.rotater').setAttrs({\n      x: width / 2,\n      y: scaledRotateAnchorOffset * Util_1.Util._sign(height) - padding,\n      scale: invertedScale,\n      visible: this.rotateEnabled()\n    });\n    this.findOne('.back').setAttrs({\n      width: width * scale.x,\n      height: height * scale.y,\n      scale: invertedScale,\n      visible: this.borderEnabled(),\n      stroke: this.borderStroke(),\n      strokeWidth: this.borderStrokeWidth(),\n      dash: this.borderDash()\n    });\n  };\n\n  Transformer.prototype.isTransforming = function () {\n    return this._transforming;\n  };\n\n  Transformer.prototype.stopTransform = function () {\n    if (this._transforming) {\n      this._removeEvents();\n\n      var anchorNode = this.findOne('.' + this._movingAnchorName);\n\n      if (anchorNode) {\n        anchorNode.stopDrag();\n      }\n    }\n  };\n\n  Transformer.prototype.destroy = function () {\n    if (this.getStage() && this._cursorChange) {\n      this.getStage().content.style.cursor = '';\n    }\n\n    Group_1.Group.prototype.destroy.call(this);\n    this.detach();\n\n    this._removeEvents();\n\n    return this;\n  };\n\n  Transformer.prototype.toObject = function () {\n    return Node_1.Node.prototype.toObject.call(this);\n  };\n\n  return Transformer;\n}(Group_1.Group);\n\nexports.Transformer = Transformer;\n\nfunction validateAnchors(val) {\n  if (!(val instanceof Array)) {\n    Util_1.Util.warn('enabledAnchors value should be an array');\n  }\n\n  if (val instanceof Array) {\n    val.forEach(function (name) {\n      if (ANCHORS_NAMES.indexOf(name) === -1) {\n        Util_1.Util.warn('Unknown anchor name: ' + name + '. Available names are: ' + ANCHORS_NAMES.join(', '));\n      }\n    });\n  }\n\n  return val || [];\n}\n\nTransformer.prototype.className = 'Transformer';\n\nGlobal_2._registerNode(Transformer);\n\nFactory_1.Factory.addGetterSetter(Transformer, 'enabledAnchors', ANCHORS_NAMES, validateAnchors);\nFactory_1.Factory.addGetterSetter(Transformer, 'resizeEnabled', true);\nFactory_1.Factory.addGetterSetter(Transformer, 'anchorSize', 10, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Transformer, 'rotateEnabled', true);\nFactory_1.Factory.addGetterSetter(Transformer, 'rotationSnaps', []);\nFactory_1.Factory.addGetterSetter(Transformer, 'rotateAnchorOffset', 50, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Transformer, 'borderEnabled', true);\nFactory_1.Factory.addGetterSetter(Transformer, 'anchorStroke', 'rgb(0, 161, 255)');\nFactory_1.Factory.addGetterSetter(Transformer, 'anchorStrokeWidth', 1, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Transformer, 'anchorFill', 'white');\nFactory_1.Factory.addGetterSetter(Transformer, 'anchorCornerRadius', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Transformer, 'borderStroke', 'rgb(0, 161, 255)');\nFactory_1.Factory.addGetterSetter(Transformer, 'borderStrokeWidth', 1, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Transformer, 'borderDash');\nFactory_1.Factory.addGetterSetter(Transformer, 'keepRatio', true);\nFactory_1.Factory.addGetterSetter(Transformer, 'centeredScaling', false);\nFactory_1.Factory.addGetterSetter(Transformer, 'ignoreStroke', false);\nFactory_1.Factory.addGetterSetter(Transformer, 'padding', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Transformer, 'node');\nFactory_1.Factory.addGetterSetter(Transformer, 'boundBoxFunc');\nFactory_1.Factory.backCompat(Transformer, {\n  lineEnabled: 'borderEnabled',\n  rotateHandlerOffset: 'rotateAnchorOffset',\n  enabledHandlers: 'enabledAnchors'\n});\nUtil_1.Collection.mapMethods(Transformer);","map":{"version":3,"sources":["/Users/coles/Documents/brett/react/shapes/app/node_modules/konva/lib/shapes/Transformer.js"],"names":["__extends","extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","__","constructor","prototype","create","defineProperty","exports","value","Util_1","require","Factory_1","Node_1","Shape_1","Rect_1","Group_1","Global_1","Validators_1","Global_2","EVENTS_NAME","ATTR_CHANGE_LIST","map","e","join","NODE_RECT","TRANSFORM_CHANGE_STR","ANGLES","getCursor","anchorName","rad","isMirrored","Util","_degToRad","angle","_radToDeg","_inRange","error","ANCHORS_NAMES","MAX_SAFE_INTEGER","Transformer","_super","config","_this","call","_transforming","_createElements","_handleMouseMove","bind","_handleMouseUp","update","on","getNode","attachTo","node","setNode","_node","detach","_resetTransformCache","additionalEvents","_attrsAffectingSize","prop","onChange","elementsCreated","findOne","off","undefined","_clearCache","_clearSelfAndDescendantCache","_getNodeRect","_getCache","__getNodeRect","x","y","width","height","rotation","parent","warn","rect","getClientRect","skipTransform","skipShadow","skipStroke","ignoreStroke","Konva","getAngle","dx","scaleX","offsetX","dy","scaleY","offsetY","Math","cos","sin","getX","getY","getRotation","getWidth","getHeight","_createBack","forEach","name","_createAnchor","anchor","Rect","stroke","fill","strokeWidth","dragDistance","draggable","self","_handleMouseDown","cancelBubble","scale","getAbsoluteScale","cursor","getStage","content","style","_cursorChange","getParent","add","back","Shape","listening","sceneFunc","ctx","tr","padding","beginPath","moveTo","rotateEnabled","lineTo","rotateAnchorOffset","_sign","fillStrokeShape","_movingAnchorName","target","split","attrs","hypotenuse","sqrt","pow","abs","window","addEventListener","_fire","evt","newHypotenuse","anchorNode","stage","box","getContent","getBoundingClientRect","zeroPoint","left","top","pointerPos","clientX","touches","clientY","newAbsPos","setAbsolutePosition","keepProportion","keepRatio","shiftKey","reverseX","reverseY","pos","position","dAlpha","atan2","PI","rot","newRotation","alpha","newAlpha","snaps","rotationSnaps","offset","i","length","dif","_fitNodeInto","angleDeg","console","Error","centeredScaling","altKey","topLeft","bottomRight","topOffsetX","topOffsetY","bottomOffsetX","bottomOffsetY","move","absPos","getAbsolutePosition","_removeEvents","removeEventListener","fire","newAttrs","boundBoxFunc","oldAttrs","pure","setAttrs","getLayer","batchDraw","forceUpdate","invertedScale","enabledAnchors","resizeEnabled","anchorSize","find","each","anchorStroke","anchorStrokeWidth","anchorFill","cornerRadius","anchorCornerRadius","visible","indexOf","scaledRotateAnchorOffset","borderEnabled","borderStroke","borderStrokeWidth","dash","borderDash","isTransforming","stopTransform","stopDrag","destroy","Group","toObject","Node","validateAnchors","val","className","_registerNode","Factory","addGetterSetter","getNumberValidator","backCompat","lineEnabled","rotateHandlerOffset","enabledHandlers","Collection","mapMethods"],"mappings":"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","sourcesContent":["\"use strict\";\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar Util_1 = require(\"../Util\");\nvar Factory_1 = require(\"../Factory\");\nvar Node_1 = require(\"../Node\");\nvar Shape_1 = require(\"../Shape\");\nvar Rect_1 = require(\"./Rect\");\nvar Group_1 = require(\"../Group\");\nvar Global_1 = require(\"../Global\");\nvar Validators_1 = require(\"../Validators\");\nvar Global_2 = require(\"../Global\");\nvar EVENTS_NAME = 'tr-konva';\nvar ATTR_CHANGE_LIST = [\n    'resizeEnabledChange',\n    'rotateAnchorOffsetChange',\n    'rotateEnabledChange',\n    'enabledAnchorsChange',\n    'anchorSizeChange',\n    'borderEnabledChange',\n    'borderStrokeChange',\n    'borderStrokeWidthChange',\n    'borderDashChange',\n    'anchorStrokeChange',\n    'anchorStrokeWidthChange',\n    'anchorFillChange',\n    'anchorCornerRadiusChange',\n    'ignoreStrokeChange'\n]\n    .map(function (e) { return e + (\".\" + EVENTS_NAME); })\n    .join(' ');\nvar NODE_RECT = 'nodeRect';\nvar TRANSFORM_CHANGE_STR = [\n    'widthChange',\n    'heightChange',\n    'scaleXChange',\n    'scaleYChange',\n    'skewXChange',\n    'skewYChange',\n    'rotationChange',\n    'offsetXChange',\n    'offsetYChange',\n    'transformsEnabledChange',\n    'strokeWidthChange'\n]\n    .map(function (e) { return e + (\".\" + EVENTS_NAME); })\n    .join(' ');\nvar ANGLES = {\n    'top-left': -45,\n    'top-center': 0,\n    'top-right': 45,\n    'middle-right': -90,\n    'middle-left': 90,\n    'bottom-left': -135,\n    'bottom-center': 180,\n    'bottom-right': 135\n};\nfunction getCursor(anchorName, rad, isMirrored) {\n    if (anchorName === 'rotater') {\n        return 'crosshair';\n    }\n    rad += Util_1.Util._degToRad(ANGLES[anchorName] || 0);\n    if (isMirrored) {\n        rad *= -1;\n    }\n    var angle = ((Util_1.Util._radToDeg(rad) % 360) + 360) % 360;\n    if (Util_1.Util._inRange(angle, 315 + 22.5, 360) || Util_1.Util._inRange(angle, 0, 22.5)) {\n        return 'ns-resize';\n    }\n    else if (Util_1.Util._inRange(angle, 45 - 22.5, 45 + 22.5)) {\n        return 'nesw-resize';\n    }\n    else if (Util_1.Util._inRange(angle, 90 - 22.5, 90 + 22.5)) {\n        return 'ew-resize';\n    }\n    else if (Util_1.Util._inRange(angle, 135 - 22.5, 135 + 22.5)) {\n        return 'nwse-resize';\n    }\n    else if (Util_1.Util._inRange(angle, 180 - 22.5, 180 + 22.5)) {\n        return 'ns-resize';\n    }\n    else if (Util_1.Util._inRange(angle, 225 - 22.5, 225 + 22.5)) {\n        return 'nesw-resize';\n    }\n    else if (Util_1.Util._inRange(angle, 270 - 22.5, 270 + 22.5)) {\n        return 'ew-resize';\n    }\n    else if (Util_1.Util._inRange(angle, 315 - 22.5, 315 + 22.5)) {\n        return 'nwse-resize';\n    }\n    else {\n        Util_1.Util.error('Transformer has unknown angle for cursor detection: ' + angle);\n        return 'pointer';\n    }\n}\nvar ANCHORS_NAMES = [\n    'top-left',\n    'top-center',\n    'top-right',\n    'middle-right',\n    'middle-left',\n    'bottom-left',\n    'bottom-center',\n    'bottom-right'\n];\nvar MAX_SAFE_INTEGER = 100000000;\nvar Transformer = (function (_super) {\n    __extends(Transformer, _super);\n    function Transformer(config) {\n        var _this = _super.call(this, config) || this;\n        _this._transforming = false;\n        _this._createElements();\n        _this._handleMouseMove = _this._handleMouseMove.bind(_this);\n        _this._handleMouseUp = _this._handleMouseUp.bind(_this);\n        _this.update = _this.update.bind(_this);\n        _this.on(ATTR_CHANGE_LIST, _this.update);\n        if (_this.getNode()) {\n            _this.update();\n        }\n        return _this;\n    }\n    Transformer.prototype.attachTo = function (node) {\n        this.setNode(node);\n        return this;\n    };\n    Transformer.prototype.setNode = function (node) {\n        var _this = this;\n        if (this._node) {\n            this.detach();\n        }\n        this._node = node;\n        this._resetTransformCache();\n        var additionalEvents = node._attrsAffectingSize\n            .map(function (prop) { return prop + 'Change.' + EVENTS_NAME; })\n            .join(' ');\n        var onChange = function () {\n            _this._resetTransformCache();\n            if (!_this._transforming) {\n                _this.update();\n            }\n        };\n        node.on(additionalEvents, onChange);\n        node.on(TRANSFORM_CHANGE_STR, onChange);\n        node.on(\"xChange.\" + EVENTS_NAME + \" yChange.\" + EVENTS_NAME, function () {\n            return _this._resetTransformCache();\n        });\n        var elementsCreated = !!this.findOne('.top-left');\n        if (elementsCreated) {\n            this.update();\n        }\n        return this;\n    };\n    Transformer.prototype.getNode = function () {\n        return this._node;\n    };\n    Transformer.prototype.detach = function () {\n        if (this.getNode()) {\n            this.getNode().off('.' + EVENTS_NAME);\n            this._node = undefined;\n        }\n        this._resetTransformCache();\n    };\n    Transformer.prototype._resetTransformCache = function () {\n        this._clearCache(NODE_RECT);\n        this._clearCache('transform');\n        this._clearSelfAndDescendantCache('absoluteTransform');\n    };\n    Transformer.prototype._getNodeRect = function () {\n        return this._getCache(NODE_RECT, this.__getNodeRect);\n    };\n    Transformer.prototype.__getNodeRect = function () {\n        var node = this.getNode();\n        if (!node) {\n            return {\n                x: -MAX_SAFE_INTEGER,\n                y: -MAX_SAFE_INTEGER,\n                width: 0,\n                height: 0,\n                rotation: 0\n            };\n        }\n        if (node.parent && this.parent && node.parent !== this.parent) {\n            Util_1.Util.warn('Transformer and attached node have different parents. Konva does not support such case right now. Please move Transformer to the parent of attaching node.');\n        }\n        var rect = node.getClientRect({\n            skipTransform: true,\n            skipShadow: true,\n            skipStroke: this.ignoreStroke()\n        });\n        var rotation = Global_1.Konva.getAngle(node.rotation());\n        var dx = rect.x * node.scaleX() - node.offsetX() * node.scaleX();\n        var dy = rect.y * node.scaleY() - node.offsetY() * node.scaleY();\n        return {\n            x: node.x() + dx * Math.cos(rotation) + dy * Math.sin(-rotation),\n            y: node.y() + dy * Math.cos(rotation) + dx * Math.sin(rotation),\n            width: rect.width * node.scaleX(),\n            height: rect.height * node.scaleY(),\n            rotation: node.rotation()\n        };\n    };\n    Transformer.prototype.getX = function () {\n        return this._getNodeRect().x;\n    };\n    Transformer.prototype.getY = function () {\n        return this._getNodeRect().y;\n    };\n    Transformer.prototype.getRotation = function () {\n        return this._getNodeRect().rotation;\n    };\n    Transformer.prototype.getWidth = function () {\n        return this._getNodeRect().width;\n    };\n    Transformer.prototype.getHeight = function () {\n        return this._getNodeRect().height;\n    };\n    Transformer.prototype._createElements = function () {\n        this._createBack();\n        ANCHORS_NAMES.forEach(function (name) {\n            this._createAnchor(name);\n        }.bind(this));\n        this._createAnchor('rotater');\n    };\n    Transformer.prototype._createAnchor = function (name) {\n        var _this = this;\n        var anchor = new Rect_1.Rect({\n            stroke: 'rgb(0, 161, 255)',\n            fill: 'white',\n            strokeWidth: 1,\n            name: name + ' _anchor',\n            dragDistance: 0,\n            draggable: true\n        });\n        var self = this;\n        anchor.on('mousedown touchstart', function (e) {\n            self._handleMouseDown(e);\n        });\n        anchor.on('dragstart', function (e) {\n            e.cancelBubble = true;\n        });\n        anchor.on('dragmove', function (e) {\n            e.cancelBubble = true;\n        });\n        anchor.on('dragend', function (e) {\n            e.cancelBubble = true;\n        });\n        anchor.on('mouseenter', function () {\n            var rad = Global_1.Konva.getAngle(_this.rotation());\n            var scale = _this.getNode().getAbsoluteScale();\n            var isMirrored = scale.y * scale.x < 0;\n            var cursor = getCursor(name, rad, isMirrored);\n            anchor.getStage().content.style.cursor = cursor;\n            _this._cursorChange = true;\n        });\n        anchor.on('mouseout', function () {\n            if (!anchor.getStage() || !anchor.getParent()) {\n                return;\n            }\n            anchor.getStage().content.style.cursor = '';\n            _this._cursorChange = false;\n        });\n        this.add(anchor);\n    };\n    Transformer.prototype._createBack = function () {\n        var back = new Shape_1.Shape({\n            name: 'back',\n            width: 0,\n            height: 0,\n            listening: false,\n            sceneFunc: function (ctx) {\n                var tr = this.getParent();\n                var padding = tr.padding();\n                ctx.beginPath();\n                ctx.rect(-padding, -padding, this.width() + padding * 2, this.height() + padding * 2);\n                ctx.moveTo(this.width() / 2, -padding);\n                if (tr.rotateEnabled()) {\n                    ctx.lineTo(this.width() / 2, -tr.rotateAnchorOffset() * Util_1.Util._sign(this.height()) - padding);\n                }\n                ctx.fillStrokeShape(this);\n            }\n        });\n        this.add(back);\n    };\n    Transformer.prototype._handleMouseDown = function (e) {\n        this._movingAnchorName = e.target.name().split(' ')[0];\n        var attrs = this._getNodeRect();\n        var width = attrs.width;\n        var height = attrs.height;\n        var hypotenuse = Math.sqrt(Math.pow(width, 2) + Math.pow(height, 2));\n        this.sin = Math.abs(height / hypotenuse);\n        this.cos = Math.abs(width / hypotenuse);\n        window.addEventListener('mousemove', this._handleMouseMove);\n        window.addEventListener('touchmove', this._handleMouseMove);\n        window.addEventListener('mouseup', this._handleMouseUp, true);\n        window.addEventListener('touchend', this._handleMouseUp, true);\n        this._transforming = true;\n        this._fire('transformstart', { evt: e });\n        this.getNode()._fire('transformstart', { evt: e });\n    };\n    Transformer.prototype._handleMouseMove = function (e) {\n        var x, y, newHypotenuse;\n        var anchorNode = this.findOne('.' + this._movingAnchorName);\n        var stage = anchorNode.getStage();\n        var box = stage.getContent().getBoundingClientRect();\n        var zeroPoint = {\n            x: box.left,\n            y: box.top\n        };\n        var pointerPos = {\n            left: e.clientX !== undefined ? e.clientX : e.touches[0].clientX,\n            top: e.clientX !== undefined ? e.clientY : e.touches[0].clientY\n        };\n        var newAbsPos = {\n            x: pointerPos.left - zeroPoint.x,\n            y: pointerPos.top - zeroPoint.y\n        };\n        anchorNode.setAbsolutePosition(newAbsPos);\n        var keepProportion = this.keepRatio() || e.shiftKey;\n        var padding = this.padding();\n        if (this._movingAnchorName === 'top-left') {\n            if (keepProportion) {\n                newHypotenuse = Math.sqrt(Math.pow(this.findOne('.bottom-right').x() - anchorNode.x() - padding * 2, 2) +\n                    Math.pow(this.findOne('.bottom-right').y() - anchorNode.y() - padding * 2, 2));\n                var reverseX = this.findOne('.top-left').x() > this.findOne('.bottom-right').x()\n                    ? -1\n                    : 1;\n                var reverseY = this.findOne('.top-left').y() > this.findOne('.bottom-right').y()\n                    ? -1\n                    : 1;\n                x = newHypotenuse * this.cos * reverseX;\n                y = newHypotenuse * this.sin * reverseY;\n                this.findOne('.top-left').x(this.findOne('.bottom-right').x() - x - padding * 2);\n                this.findOne('.top-left').y(this.findOne('.bottom-right').y() - y - padding * 2);\n            }\n        }\n        else if (this._movingAnchorName === 'top-center') {\n            this.findOne('.top-left').y(anchorNode.y());\n        }\n        else if (this._movingAnchorName === 'top-right') {\n            if (keepProportion) {\n                newHypotenuse = Math.sqrt(Math.pow(anchorNode.x() - this.findOne('.bottom-left').x() - padding * 2, 2) +\n                    Math.pow(this.findOne('.bottom-left').y() - anchorNode.y() - padding * 2, 2));\n                var reverseX = this.findOne('.top-right').x() < this.findOne('.top-left').x()\n                    ? -1\n                    : 1;\n                var reverseY = this.findOne('.top-right').y() > this.findOne('.bottom-left').y()\n                    ? -1\n                    : 1;\n                x = newHypotenuse * this.cos * reverseX;\n                y = newHypotenuse * this.sin * reverseY;\n                this.findOne('.top-right').x(x + padding);\n                this.findOne('.top-right').y(this.findOne('.bottom-left').y() - y - padding * 2);\n            }\n            var pos = anchorNode.position();\n            this.findOne('.top-left').y(pos.y);\n            this.findOne('.bottom-right').x(pos.x);\n        }\n        else if (this._movingAnchorName === 'middle-left') {\n            this.findOne('.top-left').x(anchorNode.x());\n        }\n        else if (this._movingAnchorName === 'middle-right') {\n            this.findOne('.bottom-right').x(anchorNode.x());\n        }\n        else if (this._movingAnchorName === 'bottom-left') {\n            if (keepProportion) {\n                newHypotenuse = Math.sqrt(Math.pow(this.findOne('.top-right').x() - anchorNode.x() - padding * 2, 2) +\n                    Math.pow(anchorNode.y() - this.findOne('.top-right').y() - padding * 2, 2));\n                var reverseX = this.findOne('.top-right').x() < this.findOne('.bottom-left').x()\n                    ? -1\n                    : 1;\n                var reverseY = this.findOne('.bottom-right').y() < this.findOne('.top-left').y()\n                    ? -1\n                    : 1;\n                x = newHypotenuse * this.cos * reverseX;\n                y = newHypotenuse * this.sin * reverseY;\n                this.findOne('.bottom-left').x(this.findOne('.top-right').x() - x - padding * 2);\n                this.findOne('.bottom-left').y(y + padding);\n            }\n            pos = anchorNode.position();\n            this.findOne('.top-left').x(pos.x);\n            this.findOne('.bottom-right').y(pos.y);\n        }\n        else if (this._movingAnchorName === 'bottom-center') {\n            this.findOne('.bottom-right').y(anchorNode.y());\n        }\n        else if (this._movingAnchorName === 'bottom-right') {\n            if (keepProportion) {\n                newHypotenuse = Math.sqrt(Math.pow(this.findOne('.bottom-right').x() - padding, 2) +\n                    Math.pow(this.findOne('.bottom-right').y() - padding, 2));\n                var reverseX = this.findOne('.top-left').x() > this.findOne('.bottom-right').x()\n                    ? -1\n                    : 1;\n                var reverseY = this.findOne('.top-left').y() > this.findOne('.bottom-right').y()\n                    ? -1\n                    : 1;\n                x = newHypotenuse * this.cos * reverseX;\n                y = newHypotenuse * this.sin * reverseY;\n                this.findOne('.bottom-right').x(x + padding);\n                this.findOne('.bottom-right').y(y + padding);\n            }\n        }\n        else if (this._movingAnchorName === 'rotater') {\n            var attrs = this._getNodeRect();\n            x = anchorNode.x() - attrs.width / 2;\n            y = -anchorNode.y() + attrs.height / 2;\n            var dAlpha = Math.atan2(-y, x) + Math.PI / 2;\n            if (attrs.height < 0) {\n                dAlpha -= Math.PI;\n            }\n            var rot = Global_1.Konva.getAngle(this.rotation());\n            var newRotation = Util_1.Util._radToDeg(rot) + Util_1.Util._radToDeg(dAlpha);\n            var alpha = Global_1.Konva.getAngle(this.getNode().rotation());\n            var newAlpha = Util_1.Util._degToRad(newRotation);\n            var snaps = this.rotationSnaps();\n            var offset = 0.1;\n            for (var i = 0; i < snaps.length; i++) {\n                var angle = Global_1.Konva.getAngle(snaps[i]);\n                var dif = Math.abs(angle - Util_1.Util._degToRad(newRotation)) % (Math.PI * 2);\n                if (dif < offset) {\n                    newRotation = Util_1.Util._radToDeg(angle);\n                    newAlpha = Util_1.Util._degToRad(newRotation);\n                }\n            }\n            var dx = padding;\n            var dy = padding;\n            this._fitNodeInto({\n                rotation: Global_1.Konva.angleDeg ? newRotation : Util_1.Util._degToRad(newRotation),\n                x: attrs.x +\n                    (attrs.width / 2 + padding) *\n                        (Math.cos(alpha) - Math.cos(newAlpha)) +\n                    (attrs.height / 2 + padding) *\n                        (Math.sin(-alpha) - Math.sin(-newAlpha)) -\n                    (dx * Math.cos(rot) + dy * Math.sin(-rot)),\n                y: attrs.y +\n                    (attrs.height / 2 + padding) *\n                        (Math.cos(alpha) - Math.cos(newAlpha)) +\n                    (attrs.width / 2 + padding) *\n                        (Math.sin(alpha) - Math.sin(newAlpha)) -\n                    (dy * Math.cos(rot) + dx * Math.sin(rot)),\n                width: attrs.width + padding * 2,\n                height: attrs.height + padding * 2\n            }, e);\n        }\n        else {\n            console.error(new Error('Wrong position argument of selection resizer: ' +\n                this._movingAnchorName));\n        }\n        if (this._movingAnchorName === 'rotater') {\n            return;\n        }\n        var centeredScaling = this.centeredScaling() || e.altKey;\n        if (centeredScaling) {\n            var topLeft = this.findOne('.top-left');\n            var bottomRight = this.findOne('.bottom-right');\n            var topOffsetX = topLeft.x() + padding;\n            var topOffsetY = topLeft.y() + padding;\n            var bottomOffsetX = this.getWidth() - bottomRight.x() + padding;\n            var bottomOffsetY = this.getHeight() - bottomRight.y() + padding;\n            bottomRight.move({\n                x: -topOffsetX,\n                y: -topOffsetY\n            });\n            topLeft.move({\n                x: bottomOffsetX,\n                y: bottomOffsetY\n            });\n        }\n        var absPos = this.findOne('.top-left').getAbsolutePosition(this.getParent());\n        x = absPos.x;\n        y = absPos.y;\n        var width = this.findOne('.bottom-right').x() - this.findOne('.top-left').x();\n        var height = this.findOne('.bottom-right').y() - this.findOne('.top-left').y();\n        this._fitNodeInto({\n            x: x + this.offsetX(),\n            y: y + this.offsetY(),\n            width: width,\n            height: height\n        }, e);\n    };\n    Transformer.prototype._handleMouseUp = function (e) {\n        this._removeEvents(e);\n    };\n    Transformer.prototype._removeEvents = function (e) {\n        if (this._transforming) {\n            this._transforming = false;\n            window.removeEventListener('mousemove', this._handleMouseMove);\n            window.removeEventListener('touchmove', this._handleMouseMove);\n            window.removeEventListener('mouseup', this._handleMouseUp, true);\n            window.removeEventListener('touchend', this._handleMouseUp, true);\n            this._fire('transformend', { evt: e });\n            var node = this.getNode();\n            if (node) {\n                node.fire('transformend', { evt: e });\n            }\n        }\n    };\n    Transformer.prototype._fitNodeInto = function (newAttrs, evt) {\n        var boundBoxFunc = this.boundBoxFunc();\n        if (boundBoxFunc) {\n            var oldAttrs = this._getNodeRect();\n            newAttrs = boundBoxFunc.call(this, oldAttrs, newAttrs);\n        }\n        var node = this.getNode();\n        if (newAttrs.rotation !== undefined) {\n            this.getNode().rotation(newAttrs.rotation);\n        }\n        var pure = node.getClientRect({\n            skipTransform: true,\n            skipShadow: true,\n            skipStroke: this.ignoreStroke()\n        });\n        var padding = this.padding();\n        var scaleX = pure.width ? (newAttrs.width - padding * 2) / pure.width : 1;\n        var scaleY = pure.height\n            ? (newAttrs.height - padding * 2) / pure.height\n            : 1;\n        var rotation = Global_1.Konva.getAngle(node.rotation());\n        var dx = pure.x * scaleX - padding - node.offsetX() * scaleX;\n        var dy = pure.y * scaleY - padding - node.offsetY() * scaleY;\n        this.getNode().setAttrs({\n            scaleX: scaleX,\n            scaleY: scaleY,\n            x: newAttrs.x - (dx * Math.cos(rotation) + dy * Math.sin(-rotation)),\n            y: newAttrs.y - (dy * Math.cos(rotation) + dx * Math.sin(rotation))\n        });\n        this._fire('transform', { evt: evt });\n        this.getNode()._fire('transform', { evt: evt });\n        this.update();\n        this.getLayer().batchDraw();\n    };\n    Transformer.prototype.forceUpdate = function () {\n        this._resetTransformCache();\n        this.update();\n    };\n    Transformer.prototype.update = function () {\n        var _this = this;\n        var attrs = this._getNodeRect();\n        var node = this.getNode();\n        var scale = { x: 1, y: 1 };\n        if (node && node.getParent()) {\n            scale = node.getParent().getAbsoluteScale();\n        }\n        var invertedScale = {\n            x: 1 / scale.x,\n            y: 1 / scale.y\n        };\n        var width = attrs.width;\n        var height = attrs.height;\n        var enabledAnchors = this.enabledAnchors();\n        var resizeEnabled = this.resizeEnabled();\n        var padding = this.padding();\n        var anchorSize = this.anchorSize();\n        this.find('._anchor').each(function (node) {\n            return node.setAttrs({\n                width: anchorSize,\n                height: anchorSize,\n                offsetX: anchorSize / 2,\n                offsetY: anchorSize / 2,\n                stroke: _this.anchorStroke(),\n                strokeWidth: _this.anchorStrokeWidth(),\n                fill: _this.anchorFill(),\n                cornerRadius: _this.anchorCornerRadius()\n            });\n        });\n        this.findOne('.top-left').setAttrs({\n            x: -padding,\n            y: -padding,\n            scale: invertedScale,\n            visible: resizeEnabled && enabledAnchors.indexOf('top-left') >= 0\n        });\n        this.findOne('.top-center').setAttrs({\n            x: width / 2,\n            y: -padding,\n            scale: invertedScale,\n            visible: resizeEnabled && enabledAnchors.indexOf('top-center') >= 0\n        });\n        this.findOne('.top-right').setAttrs({\n            x: width + padding,\n            y: -padding,\n            scale: invertedScale,\n            visible: resizeEnabled && enabledAnchors.indexOf('top-right') >= 0\n        });\n        this.findOne('.middle-left').setAttrs({\n            x: -padding,\n            y: height / 2,\n            scale: invertedScale,\n            visible: resizeEnabled && enabledAnchors.indexOf('middle-left') >= 0\n        });\n        this.findOne('.middle-right').setAttrs({\n            x: width + padding,\n            y: height / 2,\n            scale: invertedScale,\n            visible: resizeEnabled && enabledAnchors.indexOf('middle-right') >= 0\n        });\n        this.findOne('.bottom-left').setAttrs({\n            x: -padding,\n            y: height + padding,\n            scale: invertedScale,\n            visible: resizeEnabled && enabledAnchors.indexOf('bottom-left') >= 0\n        });\n        this.findOne('.bottom-center').setAttrs({\n            x: width / 2,\n            y: height + padding,\n            scale: invertedScale,\n            visible: resizeEnabled && enabledAnchors.indexOf('bottom-center') >= 0\n        });\n        this.findOne('.bottom-right').setAttrs({\n            x: width + padding,\n            y: height + padding,\n            scale: invertedScale,\n            visible: resizeEnabled && enabledAnchors.indexOf('bottom-right') >= 0\n        });\n        var scaledRotateAnchorOffset = -this.rotateAnchorOffset() * Math.abs(invertedScale.y);\n        this.findOne('.rotater').setAttrs({\n            x: width / 2,\n            y: scaledRotateAnchorOffset * Util_1.Util._sign(height) - padding,\n            scale: invertedScale,\n            visible: this.rotateEnabled()\n        });\n        this.findOne('.back').setAttrs({\n            width: width * scale.x,\n            height: height * scale.y,\n            scale: invertedScale,\n            visible: this.borderEnabled(),\n            stroke: this.borderStroke(),\n            strokeWidth: this.borderStrokeWidth(),\n            dash: this.borderDash()\n        });\n    };\n    Transformer.prototype.isTransforming = function () {\n        return this._transforming;\n    };\n    Transformer.prototype.stopTransform = function () {\n        if (this._transforming) {\n            this._removeEvents();\n            var anchorNode = this.findOne('.' + this._movingAnchorName);\n            if (anchorNode) {\n                anchorNode.stopDrag();\n            }\n        }\n    };\n    Transformer.prototype.destroy = function () {\n        if (this.getStage() && this._cursorChange) {\n            this.getStage().content.style.cursor = '';\n        }\n        Group_1.Group.prototype.destroy.call(this);\n        this.detach();\n        this._removeEvents();\n        return this;\n    };\n    Transformer.prototype.toObject = function () {\n        return Node_1.Node.prototype.toObject.call(this);\n    };\n    return Transformer;\n}(Group_1.Group));\nexports.Transformer = Transformer;\nfunction validateAnchors(val) {\n    if (!(val instanceof Array)) {\n        Util_1.Util.warn('enabledAnchors value should be an array');\n    }\n    if (val instanceof Array) {\n        val.forEach(function (name) {\n            if (ANCHORS_NAMES.indexOf(name) === -1) {\n                Util_1.Util.warn('Unknown anchor name: ' +\n                    name +\n                    '. Available names are: ' +\n                    ANCHORS_NAMES.join(', '));\n            }\n        });\n    }\n    return val || [];\n}\nTransformer.prototype.className = 'Transformer';\nGlobal_2._registerNode(Transformer);\nFactory_1.Factory.addGetterSetter(Transformer, 'enabledAnchors', ANCHORS_NAMES, validateAnchors);\nFactory_1.Factory.addGetterSetter(Transformer, 'resizeEnabled', true);\nFactory_1.Factory.addGetterSetter(Transformer, 'anchorSize', 10, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Transformer, 'rotateEnabled', true);\nFactory_1.Factory.addGetterSetter(Transformer, 'rotationSnaps', []);\nFactory_1.Factory.addGetterSetter(Transformer, 'rotateAnchorOffset', 50, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Transformer, 'borderEnabled', true);\nFactory_1.Factory.addGetterSetter(Transformer, 'anchorStroke', 'rgb(0, 161, 255)');\nFactory_1.Factory.addGetterSetter(Transformer, 'anchorStrokeWidth', 1, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Transformer, 'anchorFill', 'white');\nFactory_1.Factory.addGetterSetter(Transformer, 'anchorCornerRadius', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Transformer, 'borderStroke', 'rgb(0, 161, 255)');\nFactory_1.Factory.addGetterSetter(Transformer, 'borderStrokeWidth', 1, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Transformer, 'borderDash');\nFactory_1.Factory.addGetterSetter(Transformer, 'keepRatio', true);\nFactory_1.Factory.addGetterSetter(Transformer, 'centeredScaling', false);\nFactory_1.Factory.addGetterSetter(Transformer, 'ignoreStroke', false);\nFactory_1.Factory.addGetterSetter(Transformer, 'padding', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Transformer, 'node');\nFactory_1.Factory.addGetterSetter(Transformer, 'boundBoxFunc');\nFactory_1.Factory.backCompat(Transformer, {\n    lineEnabled: 'borderEnabled',\n    rotateHandlerOffset: 'rotateAnchorOffset',\n    enabledHandlers: 'enabledAnchors'\n});\nUtil_1.Collection.mapMethods(Transformer);\n"]},"metadata":{},"sourceType":"script"}